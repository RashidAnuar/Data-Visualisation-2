{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "State Ã— Year Heatmap: Poverty & Unemployment",
  "autosize": { "type": "fit", "contains": "padding" },
    "width": "container",
  "height": 420,

  "data": { "url": "poverty_unemployment_by_state_year.csv" },

  "params": [
    {
      "name": "Metric",
      "value": "poverty_absolute",
      "bind": {
        "input": "select",
        "options": [
          "poverty_absolute",
          "poverty_hardcore",
          "poverty_relative",
          "Unemployment rate"
        ],
        "labels": [
          "Absolute poverty (%)",
          "Hardcore poverty (%)",
          "Relative poverty (%)",
          "Unemployment rate (%)"
        ]
      }
    },
    { "name": "Year_Minimum", "value": 1984,
      "bind": {"input": "range", "min": 1984, "max": 2024, "step": 1} },
    { "name": "Year_Maximum", "value": 2024,
      "bind": {"input": "range", "min": 1984, "max": 2024, "step": 1} }
  ],

  "transform": [
    { "filter": "datum.Year >= Year_Minimum && datum.Year <= Year_Maximum" },

    { "impute": "poverty_absolute", "groupby": ["State"], "key": "Year", "method": "value", "value": null },
    { "impute": "poverty_hardcore", "groupby": ["State"], "key": "Year", "method": "value", "value": null },
    { "impute": "poverty_relative", "groupby": ["State"], "key": "Year", "method": "value", "value": null },
    { "impute": "Unemployment rate", "groupby": ["State"], "key": "Year", "method": "value", "value": null },

    {
      "calculate": "Metric == 'poverty_absolute' ? datum.poverty_absolute : (Metric == 'poverty_hardcore' ? datum.poverty_hardcore : (Metric == 'poverty_relative' ? datum.poverty_relative : datum['Unemployment rate']))",
      "as": "metric_value"
    },

    {
      "joinaggregate": [
        { "op": "mean", "field": "metric_value", "as": "state_mean_metric" }
      ],
      "groupby": ["State"]
    }
  ],

  "mark": { "type": "rect" },

  "encoding": {
    "x": {
      "field": "Year", "type": "ordinal", "title": "Year",
      "sort": "ascending", "axis": {"labelAngle": 0}
    },
    "y": {
      "field": "State", "type": "nominal", "title": null,
      "sort": "descending"
    },
    "color": {
      "field": "metric_value", "type": "quantitative",
      "scale": { "scheme": "blues" },
      "legend": { "orient": "right" }
    },
    "tooltip": [
      { "field": "State", "type": "nominal" },
      { "field": "Year", "type": "quantitative" },
      { "field": "poverty_absolute",   "type": "quantitative", "title": "Absolute poverty (%)",  "format": ".2f" },
      { "field": "poverty_hardcore",   "type": "quantitative", "title": "Hardcore poverty (%)",  "format": ".2f" },
      { "field": "poverty_relative",   "type": "quantitative", "title": "Relative poverty (%)",  "format": ".2f" },
      { "field": "Unemployment rate",  "type": "quantitative", "title": "Unemployment rate (%)", "format": ".2f" }
    ]
  }
}
